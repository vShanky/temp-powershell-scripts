powershell.exe -ExecutionPolicy Bypass -File Strict-Block-User.ps1 `
    -UserName "Ayaz,Shashank,Ashar" `
    -Apps "chrome.exe,whatsapp.exe,notepad.exe" `
    -Websites "facebook.com,instagram.com,twitter.com"


<#
.SYNOPSIS
Strict "Allow List Only" mode for apps + website blocking for multiple users.

.PARAMETER UserName
Comma-separated list of usernames. e.g., "Ayaz,Shashank,Ashar"

.PARAMETER Apps
Comma-separated list of apps to ALLOW. e.g., "chrome.exe,notepad.exe"

.PARAMETER Websites
Comma-separated list of websites to BLOCK. e.g., "facebook.com,instagram.com"

.NOTES
- Must run PowerShell as Administrator
- App restrictions are applied via DisallowRun per user
- Websites blocked via hosts file (applies to all users)
- Only apps in the allow list can run; all others are blocked
#>

param(
    [Parameter(Mandatory=$true)][string]$UserName,
    [Parameter(Mandatory=$true)][string]$Apps,
    [Parameter(Mandatory=$true)][string]$Websites
)

# ---------------------- Parse Parameters ----------------------
$UserList    = $UserName -split ",\s*"
$AppList     = $Apps -split ",\s*"
$WebsiteList = $Websites -split ",\s*"

Write-Host "`nüîí Strict Allow-List Mode Starting..." -ForegroundColor Cyan

# ---------------------- BLOCK APPS PER USER ----------------------
foreach ($user in $UserList) {
    Write-Host "`nProcessing user: $user" -ForegroundColor Yellow

    # Get user SID
    $localUser = Get-LocalUser -Name $user -ErrorAction SilentlyContinue
    if (-not $localUser) { Write-Host "‚ùå User $user not found"; continue }
    $sid = $localUser.SID.Value

    $userHKCU = "HKU:\$sid\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"

    # Ensure Explorer key exists
    if (-not (Test-Path $userHKCU)) {
        New-Item -Path "HKU:\$sid\Software\Microsoft\Windows\CurrentVersion\Policies" -Name "Explorer" -Force | Out-Null
    }

    # Enable DisallowRun = 1
    New-ItemProperty -Path $userHKCU -Name "DisallowRun" -Value 1 -PropertyType DWord -Force | Out-Null

    $disallowRunKey = "$userHKCU\DisallowRun"
    if (-not (Test-Path $disallowRunKey)) { New-Item -Path $userHKCU -Name "DisallowRun" -Force | Out-Null }

    # Clear existing entries (strict mode)
    Get-ItemProperty -Path $disallowRunKey -ErrorAction SilentlyContinue | ForEach-Object {
        $_.PSObject.Properties | Where-Object { $_.Name -match '^\d+$' } | ForEach-Object {
            Remove-ItemProperty -Path $disallowRunKey -Name $_.Name -Force
        }
    }

    # Add only allowed apps
    $index = 1
    foreach ($AppName in $AppList) {
        New-ItemProperty -Path $disallowRunKey -Name $index -Value $AppName -PropertyType String -Force | Out-Null
        Write-Host "‚úÖ Allowed app for $user: $AppName"
        $index++
    }
}

# ---------------------- BLOCK WEBSITES GLOBALLY ----------------------
$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"

if (-not (Test-Path $hostsPath)) { Write-Host "‚ùå hosts file not found"; exit }

foreach ($WebsiteDomain in $WebsiteList) {
    Write-Host "Blocking website: $WebsiteDomain"
    $entriesToAdd = @()

    $mainEntry = "127.0.0.1`t$WebsiteDomain"
    $wwwEntry  = "127.0.0.1`twww.$WebsiteDomain"

    if (-not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+$WebsiteDomain" -Quiet)) { $entriesToAdd += $mainEntry }
    if (-not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+www.$WebsiteDomain" -Quiet)) { $entriesToAdd += $wwwEntry }

    if ($entriesToAdd.Count -gt 0) {
        Add-Content -Path $hostsPath -Value "`n# Blocked by PowerShell script"
        $entriesToAdd | ForEach-Object { Add-Content -Path $hostsPath -Value $_ }
        Write-Host "‚úÖ Website '$WebsiteDomain' blocked."
    } else { Write-Host "‚ÑπÔ∏è Website '$WebsiteDomain' already blocked." }
}

Write-Host "`nüéâ All done!"
Write-Host "üëâ Users may need to sign out & back in for app blocks to take effect."
Write-Host "üëâ Flush DNS for website blocks: ipconfig /flushdns"
