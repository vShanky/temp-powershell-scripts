#powershell.exe -ExecutionPolicy Bypass -File Strict-Block-User.ps1 -UserName "Ayaz,Ashar" -Apps "chrome.exe,notepad.exe,whatsapp.exe" -Websites "facebook.com,instagram.com,twitter.com"


<#
.SYNOPSIS
Strict "Allow List Only" mode for apps + website blocking for multiple users.

.PARAMETER UserName
Comma-separated list of usernames. e.g., "Ayaz,Shashank,Ashar"

.PARAMETER Apps
Comma-separated list of apps to ALLOW. Only these apps will be permitted.
e.g., "chrome.exe,notepad.exe"

.PARAMETER Websites
Comma-separated list of websites to BLOCK. e.g., "facebook.com,instagram.com"

.NOTES
- Must run as Administrator
- Apps are controlled using RestrictRun (only apps in the list allowed)
- Websites blocked via hosts file (global for all users)
#>

param(
    [Parameter(Mandatory=$true)][string]$UserName,
    [Parameter(Mandatory=$true)][string]$Apps,
    [Parameter(Mandatory=$true)][string]$Websites
)

# ---------------------- Require Administrator ----------------------
if (-not ([Security.Principal.WindowsPrincipal] `
        [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole(`
        [Security.Principal.WindowsBuiltInRole]::Administrator)) {

    Write-Host "Restarting script with Administrator privileges..."
    Start-Process powershell "-ExecutionPolicy Bypass -File `"$PSCommandPath`" $($MyInvocation.UnboundArguments)" -Verb RunAs
    exit
}

Write-Host "Strict Allow-List Mode Starting..." -ForegroundColor Cyan

# ---------------------- Parse Parameters ----------------------
$UserList    = $UserName -split ",\s*"
$AppList     = $Apps -split ",\s*"
$WebsiteList = $Websites -split ",\s*"

# ---------------------- APPLY APP ALLOW-LIST PER USER ----------------------
foreach ($user in $UserList) {

    Write-Host "`nProcessing user: $user" -ForegroundColor Yellow

    # Get SID of user
    $localUser = Get-LocalUser -Name $user -ErrorAction SilentlyContinue
    if (-not $localUser) { Write-Host "User $user not found"; continue }
    $sid = $localUser.SID.Value

    $userHKCU = "HKU:\$sid\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"

    # Ensure Explorer key exists
    if (-not (Test-Path $userHKCU)) {
        New-Item -Path "HKU:\$sid\Software\Microsoft\Windows\CurrentVersion\Policies" -Name "Explorer" -Force | Out-Null
    }

    # Enable RestrictRun = 1 (strict allow-only mode)
    New-ItemProperty -Path $userHKCU -Name "RestrictRun" -Value 1 -PropertyType DWord -Force | Out-Null

    # Create RestrictRun key
    $restrictKey = "$userHKCU\RestrictRun"
    if (-not (Test-Path $restrictKey)) {
        New-Item -Path $userHKCU -Name "RestrictRun" -Force | Out-Null
    }

    # Clear old entries
    Get-ItemProperty -Path $restrictKey -ErrorAction SilentlyContinue | ForEach-Object {
        $_.PSObject.Properties | Where-Object { $_.Name -match '^\d+$' } | ForEach-Object {
            Remove-ItemProperty -Path $restrictKey -Name $_.Name -Force
        }
    }

    # Add allowed apps
    $index = 1
    foreach ($AppName in $AppList) {
        New-ItemProperty -Path $restrictKey -Name $index -Value $AppName -PropertyType String -Force | Out-Null
        Write-Host "Allowed app for $($user): $($AppName)"
        $index++
    }
}

# ---------------------- BLOCK WEBSITES GLOBALLY ----------------------
$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"

if (-not (Test-Path $hostsPath)) {
    Write-Host "ERROR: Hosts file not found at: $hostsPath"
    exit
}

Write-Host "`nApplying website blocks..." -ForegroundColor Cyan

foreach ($WebsiteDomain in $WebsiteList) {

    Write-Host "Blocking website: $WebsiteDomain"

    $mainEntry = "127.0.0.1`t$WebsiteDomain"
    $wwwEntry  = "127.0.0.1`twww.$WebsiteDomain"

    $needsMain = -not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+$WebsiteDomain" -Quiet)
    $needsWWW  = -not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+www.$WebsiteDomain" -Quiet)

    if ($needsMain -or $needsWWW) {
        Add-Content -Path $hostsPath -Value "`n# Blocked by Parental Control Script"
        if ($needsMain) { Add-Content -Path $hostsPath -Value $mainEntry }
        if ($needsWWW)  { Add-Content -Path $hostsPath -Value $wwwEntry }

        Write-Host "Website '$WebsiteDomain' blocked."
    }
    else {
        Write-Host "Website '$WebsiteDomain' already blocked."
    }
}

# ---------------------- DONE ----------------------
Write-Host "`nAll tasks completed successfully." -ForegroundColor Green
Write-Host "Users must sign out and sign back in for app restrictions to apply."
Write-Host "Run this command to refresh website blocking immediately: ipconfig /flushdns"
