#powershell.exe -ExecutionPolicy Bypass -File Block-User.ps1 -UserName "Ayaz" -Apps "chrome.exe,whatsapp.exe" -Websites "facebook.com,instagram.com"


### This will block the websites and apps mentioned in powershell command.

param(
    [string]$UserName,
    [string]$Apps,
    [string]$Websites
)

# Convert incoming CSV values to arrays
$AppNameList = @()
if ($Apps) { $AppNameList = $Apps -split "," }

$WebsiteList = @()
if ($Websites) { $WebsiteList = $Websites -split "," }

Write-Host "==============================="
Write-Host " Dynamic Block Script Running "
Write-Host "==============================="
Write-Host "Target User  : $UserName"
Write-Host "Apps to block: $($AppNameList -join ', ')"
Write-Host "Websites     : $($WebsiteList -join ', ')"
Write-Host ""

# --------- Get the User SID ---------
try {
    $userObj = Get-LocalUser -Name $UserName -ErrorAction Stop
    $ntAccount = New-Object System.Security.Principal.NTAccount($UserName)
    $sid = $ntAccount.Translate([System.Security.Principal.SecurityIdentifier]).Value
} catch {
    Write-Host "‚ùå User '$UserName' not found." -ForegroundColor Red
    exit 1
}

Write-Host "User SID: $sid"
Write-Host ""

# Registry paths
$policiesKeyPath    = "Registry::HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Policies"
$explorerKeyPath    = "$policiesKeyPath\Explorer"
$disallowRunKeyPath = "$explorerKeyPath\DisallowRun"

# --------- Block Applications ---------
Write-Host "üîí Blocking Applications..."

# Ensure required keys exist
if (-not (Test-Path $explorerKeyPath)) {
    New-Item -Path $policiesKeyPath -Name "Explorer" -Force | Out-Null
}

New-ItemProperty -Path $explorerKeyPath -Name "DisallowRun" -Value 1 -PropertyType DWord -Force | Out-Null

if (-not (Test-Path $disallowRunKeyPath)) {
    New-Item -Path $explorerKeyPath -Name "DisallowRun" -Force | Out-Null
}

$existingValues = Get-ItemProperty -Path $disallowRunKeyPath -ErrorAction SilentlyContinue

# Find next available index
$index = 1
if ($existingValues) {
    $numbers = $existingValues.PSObject.Properties.Name | Where-Object { $_ -match '^\d+$' }
    if ($numbers.Count -gt 0) {
        $index = ([int]($numbers | Sort-Object {[int]$_} -Descending | Select-Object -First 1)) + 1
    }
}

foreach ($app in $AppNameList) {
    $app = $app.Trim()
    if ($app -eq "") { continue }

    $alreadyExists = $false

    if ($existingValues) {
        foreach ($property in $existingValues.PSObject.Properties) {
            if ($property.Value -ieq $app) {
                $alreadyExists = $true 
                break
            }
        }
    }

    if (-not $alreadyExists) {
        New-ItemProperty -Path $disallowRunKeyPath -Name $index -Value $app -PropertyType String -Force | Out-Null
        Write-Host "‚úÖ App blocked: $app (index $index)"
        $index++
    } else {
        Write-Host "‚ÑπÔ∏è Already blocked: $app"
    }
}

Write-Host ""

# --------- Block Websites (hosts file) ---------
Write-Host "üåê Blocking Websites..."

$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"

if (-not (Test-Path $hostsPath)) {
    Write-Host "‚ùå hosts file not found!" -ForegroundColor Red
} else {

    foreach ($site in $WebsiteList) {
        $site = $site.Trim()
        if ($site -eq "") { continue }

        $mainEntry = "127.0.0.1`t$site"
        $wwwEntry  = "127.0.0.1`twww.$site"

        $needsMain = -not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+$site" -Quiet)
        $needsWww  = -not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+www\.$site" -Quiet)

        if ($needsMain -or $needsWww) {
            Add-Content $hostsPath "`n# Added by Block-User.ps1"
        }

        if ($needsMain) {
            Add-Content $hostsPath $mainEntry
            Write-Host "‚úÖ Website blocked: $site"
        }

        if ($needsWww) {
            Add-Content $hostsPath $wwwEntry
            Write-Host "‚úÖ Website blocked: www.$site"
        }

        if (-not $needsMain -and -not $needsWww) {
            Write-Host "‚ÑπÔ∏è Website already blocked: $site"
        }
    }
}

Write-Host ""
Write-Host "üéâ DONE!"
Write-Host "üëâ Ask the target user to log out & log in again for app blocking."
Write-Host "üëâ Run 'ipconfig /flushdns' to apply website blocking."
