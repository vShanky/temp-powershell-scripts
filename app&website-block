<#
    Script: Block App + Website for a specific user
    How to use:
    1. Change $TargetUserName, $AppName, $WebsiteDomain
    2. Save as Block-User.ps1
    3. Run PowerShell as Administrator and run:  .\Block-User.ps1
#>

# ============= CHANGE THESE ONLY =============
# Windows local user name (not email, just account name)
$TargetUserName = "childuser"

# App exe name to block
$AppName       = "chrome.exe"         # e.g. whatsapp.exe, chrome.exe, game.exe

# Website domain to block (hosts = affects ALL users)
$WebsiteDomain = "facebook.com"
# ============================================

Write-Host "Target user  : $TargetUserName"
Write-Host "Block app    : $AppName"
Write-Host "Block website: $WebsiteDomain"
Write-Host ""

# --------- GET USER SID (needed for HKEY_USERS\SID) ---------
try {
    # For local accounts
    $userObj = Get-LocalUser -Name $TargetUserName -ErrorAction Stop
    $ntAccount = New-Object System.Security.Principal.NTAccount($TargetUserName)
    $sid = $ntAccount.Translate([System.Security.Principal.SecurityIdentifier]).Value
}
catch {
    Write-Host "‚ùå Could not find local user '$TargetUserName'. Check the name." -ForegroundColor Red
    exit 1
}

Write-Host "User SID: $sid"
Write-Host ""

# Registry base for that user
$policiesKeyPath    = "Registry::HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Policies"
$explorerKeyPath    = "$policiesKeyPath\Explorer"
$disallowRunKeyPath = "$explorerKeyPath\DisallowRun"

### 1) BLOCK APP FROM RUNNING (per-user DisallowRun)

Write-Host "üîí Setting app block for user $TargetUserName ..."

# Ensure Policies\Explorer exist
if (-not (Test-Path $explorerKeyPath)) {
    New-Item -Path $policiesKeyPath -Name "Explorer" -Force | Out-Null
}

# Enable DisallowRun (DWORD value DisallowRun = 1)
New-ItemProperty -Path $explorerKeyPath -Name "DisallowRun" -Value 1 -PropertyType DWord -Force | Out-Null

# Create DisallowRun subkey if it doesn‚Äôt exist
if (-not (Test-Path $disallowRunKeyPath)) {
    New-Item -Path $explorerKeyPath -Name "DisallowRun" -Force | Out-Null
}

# Check if this app is already blocked
$existingValues = Get-ItemProperty -Path $disallowRunKeyPath -ErrorAction SilentlyContinue
$appAlreadyBlocked = $false

if ($existingValues) {
    foreach ($property in $existingValues.PSObject.Properties) {
        if ($property.Value -ieq $AppName) {
            $appAlreadyBlocked = $true
            break
        }
    }
}

if (-not $appAlreadyBlocked) {
    # Find free index (1,2,3,...)
    $index = 1
    if ($existingValues) {
        $numbers = $existingValues.PSObject.Properties.Name | Where-Object { $_ -match '^\d+$' }
        if ($numbers.Count -gt 0) {
            $index = ([int]($numbers | Sort-Object {[int]$_} -Descending | Select-Object -First 1)) + 1
        }
    }

    New-ItemProperty -Path $disallowRunKeyPath -Name $index -Value $AppName -PropertyType String -Force | Out-Null
    Write-Host "‚úÖ App '$AppName' added to block list for user '$TargetUserName' (entry $index)."
} else {
    Write-Host "‚ÑπÔ∏è App '$AppName' already blocked for user '$TargetUserName'."
}

Write-Host ""

### 2) BLOCK WEBSITE BY EDITING HOSTS FILE (ALL USERS)

Write-Host "üåê Blocking website via hosts (this affects ALL users)..."

$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"

if (-not (Test-Path $hostsPath)) {
    Write-Host "‚ùå hosts file not found at $hostsPath"
} else {
    $entriesToAdd = @()

    # Main domain
    $mainEntry = "127.0.0.1`t$WebsiteDomain"
    if (-not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+$WebsiteDomain" -Quiet)) {
        $entriesToAdd += $mainEntry
    }

    # www.domain
    $wwwDomain = "www.$WebsiteDomain"
    $wwwEntry  = "127.0.0.1`t$wwwDomain"
    if (-not (Select-String -Path $hostsPath -Pattern "^\s*127\.0\.0\.1\s+$wwwDomain" -Quiet)) {
        $entriesToAdd += $wwwEntry
    }

    if ($entriesToAdd.Count -gt 0) {
        Add-Content -Path $hostsPath -Value "`n# Blocked by PowerShell script"
        $entriesToAdd | ForEach-Object { Add-Content -Path $hostsPath -Value $_ }
        Write-Host "‚úÖ Website '$WebsiteDomain' blocked (and www.$WebsiteDomain)."
    } else {
        Write-Host "‚ÑπÔ∏è Website '$WebsiteDomain' already blocked in hosts file."
    }
}

Write-Host ""
Write-Host "üéâ Done!"
Write-Host "üëâ Ask user '$TargetUserName' to sign out & sign in again (or restart) for app block to fully apply."
Write-Host "üëâ For website, close browser & run:  ipconfig /flushdns"
